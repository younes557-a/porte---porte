<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Réinitialiser le mot de passe</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:20px}
    .box{max-width:560px;margin:0 auto;border:1px solid #ddd;border-radius:10px;padding:16px}
    .row{display:flex;gap:8px;align-items:center}
    .input{border:1px solid #111;border-radius:8px;padding:8px 10px;width:100%}
    .btn{border:1px solid #111;border-radius:8px;padding:8px 12px;background:#111;color:#fff;cursor:pointer}
    pre{background:#111;color:#0f0;padding:8px;border-radius:8px;white-space:pre-wrap}
  </style>
</head>
<body>
  <div class="box">
    <h2>Réinitialiser le mot de passe</h2>
    <p>Ouvrez cette page via le lien reçu par email.</p>
    <div id="msg" style="margin:8px 0;color:#444"></div>
    <div class="row">
      <input id="newpass" class="input" type="password" placeholder="Nouveau mot de passe (min 8)" autocomplete="new-password" />
      <button id="btnSet" class="btn">Mettre à jour</button>
    </div>
    <details style="margin-top:10px"><summary>Logs</summary><pre id="log"></pre></details>
  </div>

<script>
  const { createClient } = window.supabase;
  const SUPABASE_URL  = 'https://ybzwaemympmesdttyvqi.supabase.co';
  const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliendhZW15bXBtZXNkdHR5dnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDI3MjcsImV4cCI6MjA3MzQxODcyN30.MfFsFmpxYGWp-PIR4TXYKjXqOZY0On1r3Y0QUvqNkTc';
  const sb = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true } });

  const $ = id => document.getElementById(id);
  const log = (...a)=>{ $('log').textContent += a.map(x=>typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + '\n'; };

  async function openSessionFromHash() {
    const hash = location.hash || '';
    const p = new URLSearchParams(hash.startsWith('#') ? hash.slice(1) : hash);
    const access_token  = p.get('access_token');
    const refresh_token = p.get('refresh_token');
    if (!access_token || !refresh_token) { $('msg').innerHTML = '<b style="color:#b00">Lien invalide/expiré.</b>'; return false; }
    const { data, error } = await sb.auth.setSession({ access_token, refresh_token });
    if (error) { $('msg').innerHTML = '<b style="color:#b00">Impossible d’ouvrir la session :</b> ' + (error.message||''); log('setSession error:', error); return false; }
    log('Session OK pour:', data.user?.email || data.user?.id);
    return true;
  }

  $('btnSet').onclick = async () => {
    const np = $('newpass').value.trim();
    if (!np || np.length < 8) { $('msg').textContent = 'Mot de passe trop court (min 8).'; return; }
    const { error } = await sb.auth.updateUser({ password: np });
    if (error) { $('msg').innerHTML = '<b style="color:#b00">updateUser error:</b> ' + error.message; return; }
    $('msg').textContent = 'Mot de passe mis à jour. Redirection…';
    setTimeout(()=> location.href = 'https://younes557-a.github.io/porte---porte/', 1200);
  };

  (async()=>{ if (await openSessionFromHash()) $('msg').textContent = 'Session ouverte. Saisis un nouveau mot de passe.'; })();
</script>
</body>
</html>

