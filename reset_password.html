<!doctype html>
<meta charset="utf-8">
<title>Réinitialiser le mot de passe</title>
<div style="font-family:system-ui;max-width:420px;margin:48px auto">
  <h2>Réinitialiser le mot de passe</h2>
  <p id="step">Ouverture de session à partir du lien…</p>
  <div id="form" style="display:none">
    <p><input id="pwd1" type="password" placeholder="Nouveau mot de passe" style="width:100%;padding:10px"></p>
    <p><input id="pwd2" type="password" placeholder="Confirmer le mot de passe" style="width:100%;padding:10px"></p>
    <p><button id="set" style="padding:10px 14px">Valider</button></p>
    <p id="msg" style="color:#b91c1c"></p>
  </div>
  <p><a href="./">← Retour à l’application</a></p>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://ybzwaemympmesdttyvqi.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliendhZW15bXBtZXNkdHR5dnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDI3MjcsImV4cCI6MjA3MzQxODcyN30.MfFsFmpxYGWp-PIR4TXYKjXqOZY0On1r3Y0QUvqNkTc'
);

const step = document.getElementById('step');
const form = document.getElementById('form');
const msg  = document.getElementById('msg');
const $    = id => document.getElementById(id);

try {
  // 1) Consomme le lien de l’email (type=recovery, access_token…)
  const { error } = await supabase.auth.exchangeCodeForSession(window.location.href);
  if (error) {
    step.textContent = 'Lien invalide ou expiré. Redemandez un email de réinitialisation.';
  } else {
    step.textContent = 'Lien validé. Choisissez un nouveau mot de passe :';
    form.style.display = 'block';
  }
} catch(e){ step.textContent = 'Erreur : ' + e.message; }

document.getElementById('set').onclick = async () => {
  msg.textContent = '';
  const a = $('pwd1').value.trim();
  const b = $('pwd2').value.trim();
  if (!a || a !== b) { msg.textContent = 'Les mots de passe ne correspondent pas.'; return; }
  const { error } = await supabase.auth.updateUser({ password: a });
  if (error) { msg.textContent = error.message; return; }
  step.textContent = 'Mot de passe mis à jour. Vous pouvez retourner à l’application et vous connecter.';
  form.style.display = 'none';
};
</script>
