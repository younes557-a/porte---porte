<!doctype html>
<meta charset="utf-8">
<title>Réinitialiser le mot de passe</title>
<div style="font-family:system-ui;max-width:460px;margin:48px auto">
  <h2>Réinitialiser le mot de passe</h2>
  <p id="step">Ouverture de session à partir du lien…</p>
  <pre id="debug" style="background:#111;color:#0ff;padding:10px;white-space:pre-wrap;display:none"></pre>
  <div id="form" style="display:none">
    <p><input id="pwd1" type="password" placeholder="Nouveau mot de passe" style="width:100%;padding:10px"></p>
    <p><input id="pwd2" type="password" placeholder="Confirmer le mot de passe" style="width:100%;padding:10px"></p>
    <p><button id="set" style="padding:10px 14px">Valider</button></p>
    <p id="msg" style="color:#b91c1c"></p>
  </div>
  <p><a href="./">← Retour à l’application</a></p>
</div>

<script type="module">
import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

const supabase = createClient(
  'https://ybzwaemympmesdttyvqi.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliendhZW15bXBtZXNkdHR5dnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDI3MjcsImV4cCI6MjA3MzQxODcyN30.MfFsFmpxYGWp-PIR4TXYKjXqOZY0On1r3Y0QUvqNkTc'
);

const step = document.getElementById('step');
const dbg  = document.getElementById('debug');
const form = document.getElementById('form');
const msg  = document.getElementById('msg');
const $    = id => document.getElementById(id);

function showDebug(...a){ dbg.style.display='block'; dbg.textContent += a.map(x=> typeof x==='string'?x:JSON.stringify(x,null,2)).join(' ') + '\n'; }

function parseHash() {
  const h = window.location.hash.startsWith('#') ? window.location.hash.slice(1) : window.location.hash;
  const params = new URLSearchParams(h);
  return {
    access_token:  params.get('access_token'),
    refresh_token: params.get('refresh_token'),
    expires_in:    params.get('expires_in'),
    token_type:    params.get('token_type'),
    type:          params.get('type'),   // should be 'recovery'
    code:          params.get('code')
  };
}

async function openSessionFromUrl() {
  // 1) tentative standard
  const r1 = await supabase.auth.exchangeCodeForSession(window.location.href);
  if (!r1.error) return { ok:true, how:'exchange' };
  showDebug('exchangeCodeForSession error:', r1.error);

  // 2) fallback: setSession avec le hash
  const h = parseHash();
  if (h.access_token && h.refresh_token) {
    const r2 = await supabase.auth.setSession({ access_token:h.access_token, refresh_token:h.refresh_token });
    if (!r2.error) return { ok:true, how:'setSession' };
    showDebug('setSession error:', r2.error);
    return { ok:false, error:r2.error };
  }

  return { ok:false, error:r1.error || { message:'No tokens in URL hash' } };
}

try {
  const res = await openSessionFromUrl();
  if (!res.ok) {
    step.textContent = 'Lien invalide ou expiré. Redemandez un email de réinitialisation.';
  } else {
    step.textContent = 'Lien validé ('+res.how+'). Choisissez un nouveau mot de passe :';
    form.style.display = 'block';
  }
} catch(e){
  showDebug('Unexpected error:', e);
  step.textContent = 'Erreur: ' + (e.message||e);
}

document.getElementById('set').onclick = async () => {
  msg.textContent = '';
  const a = $('pwd1').value.trim();
  const b = $('pwd2').value.trim();
  if (!a || a !== b) { msg.textContent = 'Les mots de passe ne correspondent pas.'; return; }
  const { error } = await supabase.auth.updateUser({ password: a });
  if (error) { msg.textContent = error.message; return; }
  step.textContent = 'Mot de passe mis à jour. Vous pouvez retourner à l’application et vous connecter.';
  form.style.display = 'none';
};
</script>
