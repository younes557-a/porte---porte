<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Porte-à-porte — Supabase</title>
  <style>
    :root{--bg:#fff;--fg:#111;--muted:#555;--pri:#2563eb;--bd:#111}
    *{box-sizing:border-box}
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#fff;color:#111;margin:0}
    .wrap{max-width:1200px;margin:0 auto;padding:16px}
    h1{margin:0 0 4px 0;font-size:clamp(20px,2.6vw,28px)}
    .muted{color:#555;font-size:13px}
    .card{background:#fff;border-radius:14px;box-shadow:0 10px 24px -12px rgba(0,0,0,.18);padding:14px;margin-top:10px;border:1.5px solid #111}
    .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
    .btn{border:1.5px solid #111;background:#fff;color:#111;border-radius:12px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.primary{background:#2563eb;color:#fff;border-color:#2563eb}
    .input, select, textarea{border:1.5px solid #111;border-radius:10px;padding:8px 10px;background:#fff;color:#111}
    table{border-collapse:collapse;width:100%;font-size:14px}
    thead th{position:sticky;top:0;background:#fff;border-bottom:1px solid #e5e7eb;text-align:left;padding:8px}
    tbody td{border-bottom:1px solid #f0f0f0;padding:8px;vertical-align:top}
    .pill{display:inline-block;border-radius:999px;padding:2px 8px;font-weight:700;font-size:12px}
    .pill.fav{background:#dcfce7;color:#166534}.pill.def{background:#fee2e2;color:#991b1b}
    .pill.ind{background:#e0e7ff;color:#3730a3}.pill.abs{background:#e5e7eb;color:#111827}.pill.nc{background:#e5e7eb;color:#1f2937}
    .row-fav{background:#eaffea}.row-def{background:#ffecec}.row-ind{background:#eef2ff}
    .hidden{display:none}
    .logs{background:#111;color:#0f0;padding:8px;border-radius:8px;white-space:pre-wrap}
  </style>

  <!-- Supabase SDK (UMD global) -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.js"></script>
  <script>
    const SUPABASE_URL  = 'https://ybzwaemympmesdttyvqi.supabase.co';
    const SUPABASE_ANON = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InliendhZW15bXBtZXNkdHR5dnFpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NDI3MjcsImV4cCI6MjA3MzQxODcyN30.MfFsFmpxYGWp-PIR4TXYKjXqOZY0On1r3Y0QUvqNkTc';
    const { createClient } = window.supabase;
    window.sb = createClient(SUPABASE_URL, SUPABASE_ANON, { auth: { persistSession: true } });
  </script>
</head>
<body>
<div class="wrap">
  <h1>Porte-à-porte — Supabase</h1>
  <div class="muted">Connexion requise. Accès complet à la base.</div>

  <!-- AUTH -->
  <div id="authCard" class="card">
    <div class="row" style="gap:10px;align-items:flex-end">
      <div><div class="muted">Email</div><input id="email" class="input" placeholder="benevole@asso.fr" /></div>
      <div><div class="muted">Mot de passe</div><input id="password" type="password" class="input" placeholder="••••••••" /></div>
      <button id="btnSignIn" class="btn primary">Se connecter</button>
    </div>
    <div id="authError" class="muted" style="color:#b91c1c;margin-top:6px"></div>
  </div>

  <!-- APP -->
  <div id="appCard" class="card hidden">
    <div class="row" style="justify-content:space-between">
      <div class="muted">Connecté : <b id="who"></b></div>
      <div class="row">
        <input id="q" class="input" placeholder="Recherche (nom, adresse, téléphone, email, remarque)..." style="flex:1;min-width:260px" />
        <select id="fStatus" class="input">
          <option value="">Tous les statuts</option>
          <option>Favorable</option><option>Défavorable</option>
          <option>Indécis</option><option>Absent</option><option>Non contacté</option>
        </select>
        <select id="fSecteur" class="input"><option value="">Tous les secteurs</option></select>
        <select id="fBureau" class="input"><option value="">Tous les bureaux de vote</option></select>
        <button id="btnReload" class="btn">Recharger</button>
        <button id="btnSignOut" class="btn">Se déconnecter</button>
      </div>
    </div>

    <div class="row" style="gap:8px;margin-top:8px">
      <button id="btnCSVAll" class="btn">Exporter CSV (tout)</button>
      <button id="btnCSVFav" class="btn">CSV Favorables</button>
      <button id="btnCSVIndecis" class="btn">CSV Indécis</button>
      <span class="muted" id="stats"></span>
    </div>

    <div style="max-height:60vh;overflow:auto;margin-top:10px">
      <table>
        <thead>
          <tr>
            <th>Nom</th><th>Adresse</th><th>Secteur</th><th>Bureau de vote</th>
            <th>Téléphone</th><th>Email</th>
            <th>Statut</th><th>Remarque</th><th>Actions</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>

    <details style="margin-top:10px"><summary>Logs</summary><pre class="logs" id="log"></pre></details>
  </div>
</div>

<script>
(function(){
  const $ = id => document.getElementById(id);
  const log = (...a)=>{ const s=a.map(x=> typeof x==='string'?x:JSON.stringify(x,null,2)).join(' '); console.log(...a); const el=$('log'); if(el) el.textContent += s+'\n'; };
  const EH = s => String(s||'').replace(/[&<>"']/g,m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]));
  const state = { rows:[], indexById:{}, filters:{q:'',status:'',secteur:'',bureau:''} };

  // UI -> ENUM et inverse
  const toEnum = {'Favorable':'favorable','Défavorable':'defavorable','Indécis':'neutre','Absent':'absent','Non contacté':'non_contacte'};
  const fromEnum = {'favorable':'Favorable','defavorable':'Défavorable','neutre':'Indécis','absent':'Absent','non_contacte':'Non contacté'};

  // Normalisation des clés: enlève accents/majuscules/espaces
  const norm = k => String(k||'')
    .normalize('NFD').replace(/[\u0300-\u036f]/g,'')
    .toLowerCase().replace(/[^a-z0-9]+/g,'_');

  // Accès tolérant: on construit une map clés_normalisées -> valeur
  function nmap(obj){
    const m={}; for(const k in obj){ m[norm(k)] = obj[k]; } return m;
  }
  function pickN(m, aliases){ for(const a of aliases){ if(m[a]!=null && m[a]!=='') return m[a]; } return ''; }

  function buildAdresseMap(m){
    const num = pickN(m, ['numero_de_voie','numero_dans_la_voie','numero','num']);
    const lib = pickN(m, ['libelle_de_voie','libelle_de_la_voie','rue','voie']);
    const cp  = pickN(m, ['code_postal','cp']);
    const com = pickN(m, ['commune','ville']);
    return [num,lib,cp,com].filter(Boolean).join(' ') || pickN(m, ['adresse','address']);
  }
  function buildNomMap(m){
    const first = pickN(m, ['prenom','prenoms','first_name','first']);
    const lastUsage = pickN(m, ['nom_d_usage','nom_usage','nom_dusage']);
    const lastBirth = pickN(m, ['nom_de_naissance','nom_naissance']);
    const lastPlain = pickN(m, ['nom','last_name','last']);
    const last = lastUsage || lastBirth || lastPlain;
    const full = [first,last].filter(Boolean).join(' ').trim();
    return full || pickN(m, ['nom_complet','name','display_name']) || last || first;
  }
  function buildSecteurMap(m){ return pickN(m, ['secteur','sector']); }
  function buildBureauMap(m){
    return pickN(m, [
      'libelle_du_bureau_de_vote','bureau_de_vote','bureau_vote','bureau',
      'code_du_bureau_de_vote'
    ]);
  }

  function pill(st){
    if(st==='Favorable')return'<span class="pill fav">Favorable</span>';
    if(st==='Défavorable')return'<span class="pill def">Défavorable</span>';
    if(st==='Indécis')return'<span class="pill ind">Indécis</span>';
    if(st==='Absent')return'<span class="pill abs">Absent</span>';
    return'<span class="pill nc">Non contacté</span>';
  }
  function rowCls(st){ return st==='Favorable'?'row-fav':st==='Défavorable'?'row-def':(st==='Indécis'||st==='Non contacté')?'row-ind':''; }

  function filtered(){
    const q=(state.filters.q||'').toLowerCase();
    return state.rows.filter(r=>{
      const okS=!state.filters.status || r.statut===state.filters.status;
      const okSect=!state.filters.secteur || r.secteur===state.filters.secteur;
      const okBur=!state.filters.bureau || r.bureau===state.filters.bureau;
      const okQ=!q || [r.nom,r.adresse,r.secteur,r.bureau,r.telephone,r.email,r.remarque]
        .some(v=> String(v||'').toLowerCase().includes(q));
      return okS && okSect && okBur && okQ;
    });
  }
  function updateStats(){
    const fav=state.rows.filter(r=>r.statut==='Favorable').length;
    const def=state.rows.filter(r=>r.statut==='Défavorable').length;
    const ind=state.rows.filter(r=>r.statut==='Indécis').length;
    const abs=state.rows.filter(r=>r.statut==='Absent').length;
    const nc =state.rows.filter(r=>!r.statut || r.statut==='Non contacté').length;
    $('stats').textContent = ` | Fav: ${fav} Déf: ${def} Indécis: ${ind} Absent: ${abs} Non contacté: ${nc} | Total: ${state.rows.length}`;
  }
  function render(){
    const rows=filtered();
    $('tbody').innerHTML=rows.map(r=>`
      <tr class="${rowCls(r.statut)}">
        <td>${EH(r.nom)}</td>
        <td>${EH(r.adresse)}</td>
        <td>${EH(r.secteur||'')}</td>
        <td>${EH(r.bureau||'')}</td>
        <td><input class="input" data-id="${r.id}" data-field="telephone" value="${EH(r.telephone||'')}" /></td>
        <td><input class="input" data-id="${r.id}" data-field="email" value="${EH(r.email||'')}" /></td>
        <td>${pill(r.statut)}</td>
        <td><textarea class="input" data-id="${r.id}" data-field="remarque">${EH(r.remarque||'')}</textarea></td>
        <td>
          <button class="btn" data-act="set" data-id="${r.id}" data-val="Favorable">Favorable</button>
          <button class="btn" data-act="set" data-id="${r.id}" data-val="Défavorable">Défavorable</button>
          <button class="btn" data-act="set" data-id="${r.id}" data-val="Indécis">Indécis</button>
          <button class="btn" data-act="set" data-id="${r.id}" data-val="Absent">Absent</button>
          <button class="btn" data-act="set" data-id="${r.id}" data-val="Non contacté">Non contacté</button>
        </td>
      </tr>`).join('');
    updateStats();
  }

  function populateFilters(){
    const uniq = (arr)=> [...new Set(arr.filter(Boolean))].sort((a,b)=>String(a).localeCompare(String(b),'fr'));
    const secteurs = uniq(state.rows.map(r=>r.secteur));
    const bureaux  = uniq(state.rows.map(r=>r.bureau));
    $('fSecteur').innerHTML = '<option value="">Tous les secteurs</option>' + secteurs.map(s=>`<option>${EH(s)}</option>`).join('');
    $('fBureau').innerHTML  = '<option value="">Tous les bureaux de vote</option>' + bureaux.map(s=>`<option>${EH(s)}</option>`).join('');
  }

  // ===== RÉCUPÉRATION TOTALE (pagination 1000) =====
  async function fetchAllContacts(pageSize=1000){
    let all = [], from = 0, to = pageSize - 1;
    for(;;){
      const { data, error } = await sb.from('contacts').select('*').range(from, to);
      if (error){ return { data: all, error }; }
      all = all.concat(data||[]);
      if (!data || data.length < pageSize) break;
      from += pageSize; to += pageSize;
    }
    return { data: all, error: null };
  }

  async function loadContacts(){
    const { data, error } = await fetchAllContacts(1000);
    if (error){ log('[loadContacts ERROR]', error); alert(error.message); return; }

    state.rows = (data||[]).map(c=>{
      const m = nmap(c);
      const statutBrut = c.status ?? c.statut ?? c.status_enum ?? c.visit_status ?? '';
      const statutUI = fromEnum[String(statutBrut)] || (String(statutBrut).toLowerCase()==='neutre' ? 'Indécis' : (statutBrut || 'Non contacté'));
      return {
        id: c.id,
        nom: buildNomMap(m),
        adresse: buildAdresseMap(m),
        secteur: buildSecteurMap(m),
        bureau: buildBureauMap(m),
        telephone: pickN(m, ['phone','telephone','telephone_1']),
        email: pickN(m, ['email','courriel']),
        statut: statutUI,
        remarque: c.remark || c.remarque || ''
      };
    });

    state.indexById={}; state.rows.forEach(r => state.indexById[r.id]=r);
    log('[contacts loaded]', state.rows.length);
    populateFilters();
    render();
  }

  // ===== AUTH / BOOT =====
  async function boot(){
    const { data:{ session } } = await sb.auth.getSession();
    if (session?.user){
      $('who').textContent = session.user.email || session.user.id;
      $('authCard').classList.add('hidden');
      $('appCard').classList.remove('hidden');
      await loadContacts();
    } else {
      $('appCard').classList.add('hidden');
      $('authCard').classList.remove('hidden');
    }
  }

  // ===== EVENTS =====
  $('btnSignIn').onclick = async ()=>{
    $('authError').textContent='';
    const email=$('email').value.trim().toLowerCase();
    const password=$('password').value.trim();
    if(!email || !password){ $('authError').textContent='Saisis email et mot de passe.'; return; }
    const { error } = await sb.auth.signInWithPassword({ email, password });
    if (error){ $('authError').textContent=error.message; return; }
    await boot();
  };
  $('btnSignOut').onclick = async ()=>{ await sb.auth.signOut(); await boot(); };
  sb.auth.onAuthStateChange(()=> boot());

  // Clic statut
  document.addEventListener('click', async (e)=>{
    const b = e.target.closest('button[data-act="set"]'); if(!b) return;
    const id=b.dataset.id, label=b.dataset.val;                 // "Indécis"
    const enumValue = toEnum[label] || label;                   // "neutre"
    const { data: u } = await sb.auth.getUser();
    const updated_by = u?.user?.id;

    // 1) insert visits (enum)
    const ins = await sb.from('visits').insert([{ contact_id:id, status: enumValue, remark:'', updated_by }]);
    if (ins.error){ alert(ins.error.message); return; }

    // 2) update contacts.status (enum) sinon fallback texte
    let up = await sb.from('contacts').update({ status: enumValue }).eq('id', id);
    if (up.error){
      up = await sb.from('contacts').update({ status: label }).eq('id', id);
      // si encore erreur on laisse mais l'info est bien dans visits
    }

    // 3) UI
    const r=state.indexById[id]; if(r){ r.statut = label; render(); }
  });

  // Éditions champs simples
  document.addEventListener('input', async (e)=>{
    const el=e.target.closest('input[data-id],textarea[data-id]'); if(!el) return;
    const id=el.dataset.id, field=el.dataset.field, val=el.value;
    const patch={};
    if(field==='telephone') patch.phone=val;
    if(field==='email') patch.email=val;
    if(field==='remarque') patch.remark=val;
    if (Object.keys(patch).length){
      const { error } = await sb.from('contacts').update(patch).eq('id', id);
      if (error){ alert(error.message); }
      else { const r=state.indexById[id]; if(r){ r[field]=val; } }
    }
  });

  // Filtres & reload
  $('q').oninput     = e=>{ state.filters.q=e.target.value; render(); };
  $('fStatus').onchange  = e=>{ state.filters.status=e.target.value; render(); };
  $('fSecteur').onchange = e=>{ state.filters.secteur=e.target.value; render(); };
  $('fBureau').onchange  = e=>{ state.filters.bureau=e.target.value; render(); };
  $('btnReload').onclick = loadContacts;

  // CSV
  const toCSV = rows=>{
    const cols=['Nom','Adresse','Secteur','Bureau de vote','Téléphone','Email','Statut','Remarque'];
    const esc=v=>`"${String(v??'').replace(/"/g,'""')}"`;
    return cols.join(';')+'\n'+rows.map(r=>[r.nom,r.adresse,r.secteur,r.bureau,r.telephone,r.email,r.statut||'',r.remarque||''].map(esc).join(';')).join('\n');
  };
  function downloadCSV(name, rows){
    const blob=new Blob([toCSV(rows)],{type:'text/csv;charset=utf-8;'});
    const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=(name.endsWith('.csv')?name:name+'.csv'); a.click(); URL.revokeObjectURL(a.href);
  }
  $('btnCSVAll').onclick     = ()=> downloadCSV('liste_complete', state.rows);
  $('btnCSVFav').onclick     = ()=> downloadCSV('favorables', state.rows.filter(r=>r.statut==='Favorable'));
  $('btnCSVIndecis').onclick = ()=> downloadCSV('indecis', state.rows.filter(r=>r.statut==='Indécis'));

  // GO
  boot();
})();
</script>
</body>
</html>
